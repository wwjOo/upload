<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件编辑器</title>

    <style>
        #editor {
            width: 98%;
            height: 900px;
            border: 1px solid #978fdd;
            font-size: 20px;
            overflow-x: auto;
            overflow-y: auto;
            padding: 10px;
            margin: 10px 0px; 
            white-space: pre; /* 保留空格和制表符，并允许自动换行 */
            font-family: monospace; /* 使用等宽字体，更适合编辑代码和文本 */
        }
        #loadButton {
            color: rgb(0, 0, 0);
            transition: background-color 0.3s ease;
        }
        #loadButton.loading {
            color: #FF9800; /* 加载中的颜色 */
        }
        #loadButton.success {
            color: #06702f; /* 成功后的颜色 */
        }
    </style>
</head>

<body>
    <div>
        <label for="filePathInput">文件路径(相对于根目录/): </label>
        <input type="text" id="filePathInput">
        <button id="loadButton" onclick="LoadFile()">读取文件</button>
        <button onclick="saveFile()">保存文件</button>
        <div id="editor" contenteditable="true"></div>
    </div>
    
    
    <script>
        //加载文件 //TODO : 默认会加载html待解决
        function LoadFile() {
            var filePath = document.getElementById('filePathInput').value.trim();
            if (filePath === '') {
                alert('文件路径不能为空');
                return;
            }

            //末尾添加一个随机参数，可以绕过浏览器缓存机制，强制每次都请求新的内容
            filePath += '?rand=' + Math.random().toString(36).substr(2);
            console.log(filePath);
            fetch(filePath)
            .then(response => {
                if (!response.ok) {
                    alert('无法加载文件');
                    throw new Error('无法加载文件');
                }
                return response.text();
            })
            .then(data => {
                var button = document.getElementById('loadButton');
                button.innerText = '读取成功';
                button.classList.remove('loading'); // 移除加载中的样式类
                button.classList.add('success'); // 添加成功的样式类
                // 2秒后恢复原始文字
                setTimeout(function() {
                    button.innerText = '读取文件';
                    button.classList.remove('success'); // 移除成功的样式类
                }, 2000);

                document.getElementById('editor').innerText = data;
            })
            .catch(error => {
                console.error('加载文件时出错：', error);
            });
        }
        
        //保存文件
        function saveFile() {
            var filePath = document.getElementById('filePathInput').value.trim();    
            if(filePath === ""){
                alert("请先读取文件");
                return;
            }

            var content = document.getElementById('editor').innerText;       
            if(content === ""){
                var result = confirm(filePath + "的内容将被删除，是否继续?");
                if(!result)
                    return;
            }

            var formData = new FormData();
            formData.append('content', content);
            formData.append('filepath', filePath);

            fetch('upload.php', 
            {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('出现错误，请稍后重试。');
            });
        }


        // 获取编辑器元素
        var editor = document.getElementById('editor');

        // 监听键盘按下事件
        editor.addEventListener('keydown', function(e) {
            // 捕获按键事件
            if (e.key === 'Tab') {
                // 阻止默认行为（浏览器默认会切换焦点）
                e.preventDefault();

                // 在光标当前位置插入Tab字符（可以自定义Tab宽度）
                var cursorPosition = getCaretPosition(editor);
                var text = editor.innerText;
                var newText = text.substring(0, cursorPosition) + '\t' + text.substring(cursorPosition);
                editor.innerText = newText;

                // 重新设置光标位置
                setCaretPosition(editor, cursorPosition + 1);
            }
        });

        // 获取光标位置
        function getCaretPosition(element) {
            var caretOffset = 0;
            var doc = element.ownerDocument || element.document;
            var win = doc.defaultView || doc.parentWindow;
            var sel;
            if (typeof win.getSelection != "undefined") {
                sel = win.getSelection();
                if (sel.rangeCount > 0) {
                    var range = win.getSelection().getRangeAt(0);
                    var preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    caretOffset = preCaretRange.toString().length;
                }
            } else if ((sel = doc.selection) && sel.type != "Control") {
                var textRange = sel.createRange();
                var preCaretTextRange = doc.body.createTextRange();
                preCaretTextRange.moveToElementText(element);
                preCaretTextRange.setEndPoint("EndToEnd", textRange);
                caretOffset = preCaretTextRange.text.length;
            }
            return caretOffset;
        }

        // 设置光标位置
        function setCaretPosition(element, caretPos) {
            var range = document.createRange();
            var sel = window.getSelection();
            range.setStart(element.childNodes[0], caretPos);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            element.focus();
        }
    </script>
</body>
</html>